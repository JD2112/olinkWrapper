name: Deploy MkDocs with mike

on:
  push:
    tags:
      - "v*"        # run when you push tags like v1.3.0

permissions:
  contents: write   # allow pushing to gh-pages

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # mike needs history

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install mkdocs mike mkdocs-material

      - name: Configure Git author
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy with mike
        env:
          # Actions provides a token with write perms because of 'permissions: contents: write'
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          # Tag name is already available as GITHUB_REF_NAME (e.g., v1.3.0)
          VERSION="${GITHUB_REF_NAME}"
          ALIAS="latest"

          echo "Deploying version $VERSION"

          # Ensure we're on the branch where mkdocs.yml lives
          git checkout ${{ github.ref_name == 'gh-pages' && 'main' || 'main' }}

          # Build & write to gh-pages via mike (no manual checkout needed)
          mike deploy --push --update-aliases "$VERSION" "$ALIAS"
          mike set-default --push "$ALIAS"
